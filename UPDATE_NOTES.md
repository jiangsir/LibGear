# 📸 照片功能更新說明

## 版本資訊

- **更新日期**: 2024-01-XX
- **前端版本**: v1.1.0 → **v1.2.0**
- **後端版本**: v1.2.1 → **v1.3.0**

---

## 🎯 新增功能

### 📷 設備照片上傳

借用設備時可以**拍照或上傳照片**，照片會：
- 自動上傳到 Google Drive
- 存儲 URL 到 Google Sheets
- 在 Sheets 中顯示縮圖預覽
- 在前端記錄中顯示查看連結

---

## 📋 更新內容

### 後端 (Google Apps Script)

#### 新增 API

**`uploadPhoto`** - 上傳照片到 Google Drive
- 接收 Base64 編碼的照片
- 自動建立 `LibGear_Photos` 資料夾
- 設定檔案權限為「知道連結的任何人都能檢視」
- 返回 Drive URL（格式：`https://drive.google.com/uc?id=...`）

#### 修改 API

**`recordBorrow`** - 支援照片 URL
- 新增 `photoUrl` 參數（選填）
- 照片 URL 存儲到 records 表 E 欄
- 向後兼容（無照片也能正常借用）

**`getUnreturnedGears`** - 返回照片 URL
- 回傳資料包含 `photoUrl` 欄位

**`getRecordsByDate`** - 返回照片 URL
- 回傳資料包含 `photoUrl` 欄位

### 前端 (網頁)

#### 新增功能

**拍照/選擇照片按鈕**
- 手機可直接啟動相機拍照
- 電腦可選擇圖片檔案
- 支援格式：JPG, PNG, HEIC 等

**照片預覽**
- 選擇照片後立即顯示預覽
- 可移除照片重新選擇
- 預覽大小：200x200px

**自動圖片壓縮**
- 最大尺寸：800x800px
- 壓縮品質：70%
- 減少上傳時間和儲存空間

**記錄表格顯示照片**
- 設備狀態列表新增「照片」欄
- 借用記錄列表新增「照片」欄
- 有照片的記錄顯示「查看照片」按鈕
- 點擊按鈕在新分頁開啟完整照片

#### 介面優化

- 拍照按鈕使用相機圖示
- 照片預覽區域可折疊
- 移除照片按鈕顏色為紅色
- 響應式設計，手機和電腦都友善

### Google Sheets

#### 新增欄位

**records 工作表**
- **E 欄**：`photoUrl` - 照片網址
- **F 欄**：`照片預覽` - 使用 IMAGE() 公式顯示縮圖

#### IMAGE 公式

```
=IF(E2<>"", IMAGE(E2, 4, 80, 80), "")
```

- 自動顯示 80x80 像素的照片縮圖
- 無照片時顯示空白
- 可點擊查看完整照片

---

## 🔧 技術細節

### 資料流程

```
1. 使用者選擇照片 → 2. 前端壓縮圖片 → 3. 轉換為 Base64
                                ↓
4. 上傳到後端 → 5. 後端轉換為 Blob → 6. 上傳到 Drive
                                ↓
7. 獲取 Drive URL → 8. 記錄借用 → 9. 存入 Sheets E 欄
                                ↓
10. Sheets F 欄 IMAGE() 公式顯示縮圖
```

### 儲存方案

**選擇 Google Drive 的原因**：
- ✅ 無單一檔案大小限制
- ✅ 免費 15GB 儲存空間
- ✅ 支援原圖品質
- ✅ Sheets 可用 IMAGE() 公式顯示
- ✅ 照片可獨立管理和備份

**替代方案（未採用）**：
- ❌ Base64 存入 Sheets：單一儲存格限制 50,000 字元，約 35KB 圖片
- ❌ 外部圖床：需要第三方服務，可能有穩定性問題

### 效能優化

**圖片壓縮**
- 原始照片可能 3-5MB
- 壓縮後約 50-200KB
- 上傳速度提升 10-50 倍

**非同步處理**
- 照片上傳採用異步方式
- 不阻塞借用流程
- 上傳失敗不影響借用記錄

---

## 📖 使用說明

### 借用設備時拍照

1. 輸入借用人學號
2. 輸入設備條碼
3. **（選填）** 點擊「拍照或選擇照片」按鈕
   - 手機：選擇「拍照」或「從相簿選擇」
   - 電腦：選擇圖片檔案
4. 確認照片預覽無誤
5. 點擊「借出」按鈕

### 查看借用照片

#### 在 Google Sheets 查看
1. 開啟 records 工作表
2. F 欄會顯示 80x80 照片縮圖
3. 點擊照片可查看完整圖片

#### 在網頁查看
1. 切換到「設備狀態」或「借用記錄」標籤
2. 有照片的記錄會顯示「查看照片」按鈕
3. 點擊按鈕在新分頁開啟完整照片

---

## ⚠️ 注意事項

### 隱私與安全

- ✅ 照片存儲在您的 Google Drive 中
- ✅ 權限設為「知道連結的任何人都能檢視」
- ⚠️ 任何知道 URL 的人都能查看照片
- 💡 建議定期檢查並清理不需要的照片

### 儲存空間管理

- 📊 Google Drive 免費版提供 15GB
- 📸 每張壓縮照片約 50-200KB
- 🔢 約可存儲 50,000-100,000 張照片
- 💾 建議定期備份和清理舊照片
- 📈 可升級 Google One 獲得更多空間

### 相容性

**支援的瀏覽器**：
- ✅ Chrome (桌面版、Android、iOS)
- ✅ Safari (macOS、iOS)
- ✅ Edge (桌面版、Android)
- ✅ Firefox (桌面版、Android)

**不支援的瀏覽器**：
- ❌ IE11 及更早版本

---

## 🐛 已知問題

### 手機相機權限

部分瀏覽器首次使用拍照功能時會要求授予相機權限，請選擇「允許」。

### iOS Safari 檔案上傳

iOS Safari 選擇照片時可能只顯示「照片圖庫」選項，而非「拍照」和「選擇照片」分開。這是 iOS 系統限制，屬正常現象。

### 上傳速度

照片上傳速度取決於網路連線速度。3G/4G 環境下可能需要 3-10 秒，請耐心等待。

---

## 🔄 向後相容性

### 完全相容

- ✅ 舊版本的借用記錄不受影響
- ✅ 沒有照片的記錄正常顯示
- ✅ 可選擇不上傳照片直接借用
- ✅ 前端會自動檢測後端版本

### 升級建議

**強烈建議同時更新前端和後端**，以獲得最佳體驗。

如果只更新其中一個：
- 只更新前端：拍照功能無法使用，但不影響基本借還功能
- 只更新後端：照片功能可用，但前端不顯示照片欄位

---

## 📚 相關文件

- [Google Sheets 設置指南](SHEETS_SETUP.md) - Sheets 手動設置步驟
- [部署檢查清單](DEPLOYMENT_CHECKLIST.md) - 完整部署和測試流程
- [手機功能說明](MOBILE_CAMERA_FEATURE.md) - 技術架構詳細說明
- [安裝手冊](INSTALL.md) - 完整系統安裝指南

---

## ❓ 常見問題

### Q: 照片是必填的嗎？
**A:** 不是。照片功能是**選填**的，您可以選擇不拍照直接借用設備。

### Q: 可以上傳多張照片嗎？
**A:** 目前一次借用只能上傳**一張照片**。若需要多張，建議使用拼圖 App 合併後上傳。

### Q: 照片會被壓縮嗎？
**A:** 會。系統會自動將照片壓縮到 800x800px 以下，品質 70%，以節省儲存空間和加快上傳速度。

### Q: 可以刪除已上傳的照片嗎？
**A:** 可以。前往 Google Drive 的 `LibGear_Photos` 資料夾，手動刪除照片檔案。刪除後 Sheets 中的圖片會顯示為空白或錯誤。

### Q: 照片會佔用我的 Google Drive 空間嗎？
**A:** 是的。照片存儲在您的 Google Drive 中，會佔用您的免費 15GB 空間。

### Q: 可以更改照片縮圖大小嗎？
**A:** 可以。修改 Sheets F 欄公式中的數字：
```
=IF(E2<>"", IMAGE(E2, 4, 寬度, 高度), "")
```
例如改為 `IMAGE(E2, 4, 120, 120)` 顯示 120x120 像素。

---

## 📞 技術支援

如有問題或建議，請：
1. 檢查 [部署檢查清單](DEPLOYMENT_CHECKLIST.md)
2. 查看 Google Apps Script 執行日誌
3. 檢查瀏覽器開發者工具 Console
4. 確認 Google Sheets 設定正確

---

**更新完成！享受全新的照片功能！** 📸✨
