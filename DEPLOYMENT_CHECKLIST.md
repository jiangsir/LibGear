# 📸 照片功能部署檢查清單

## 版本資訊
- **前端版本**: v1.2.0
- **後端版本**: v1.3.0
- **功能**: 設備照片上傳與顯示

---

## ✅ 部署前檢查

### 1. 後端 (Google Apps Script)

- [ ] **Code.gs 更新完成**
  - [ ] 版本號更新為 `v1.3.0`
  - [ ] `uploadPhoto()` 函數已實作
  - [ ] `recordBorrow()` 接受 `photoUrl` 參數
  - [ ] `doPost()` 新增 `uploadPhoto` case
  - [ ] `getUnreturnedGears()` 返回 `photoUrl`
  - [ ] `getRecordsByDate()` 返回 `photoUrl`

- [ ] **⚠️ 設定 Drive 權限（重要！）**
  - [ ] 在 Apps Script 編輯器中開啟「設定」
  - [ ] 勾選「顯示 appsscript.json」
  - [ ] 更新 `appsscript.json` 加入 Drive 權限
  - [ ] 詳細步驟請參考 [DRIVE_PERMISSION_SETUP.md](DRIVE_PERMISSION_SETUP.md)

- [ ] **重新部署並授權**
  - [ ] 點擊「部署」→「管理部署作業」
  - [ ] 選擇現有部署，點擊「編輯」
  - [ ] 版本選擇「新增版本」，說明：`新增 Drive 權限`
  - [ ] 點擊「部署」
  - [ ] **授權 Drive 權限**（會彈出授權視窗）
  - [ ] 允許應用程式訪問 Google Drive

### 2. 前端 (GitHub Pages)

- [ ] **檔案更新完成**
  - [ ] `docs/index.html` - 新增拍照 UI
  - [ ] `docs/js/app.js` - 照片處理邏輯
  - [ ] `docs/js/api-client.js` - uploadPhoto API
  - [ ] `docs/js/config.js` - 版本號 v1.2.0
  - [ ] `docs/css/style.css` - 無需修改

- [ ] **Git 提交與推送**
  ```bash
  git add .
  git commit -m "feat: 新增照片上傳與顯示功能 v1.2.0"
  git push origin main
  ```

### 3. Google Sheets 手動設置

- [ ] **開啟 Sheets**
  - [ ] 前往 records 工作表

- [ ] **新增欄位**
  - [ ] E1 輸入：`photoUrl`
  - [ ] F1 輸入：`照片預覽`

- [ ] **設定 IMAGE 公式**
  - [ ] F2 輸入：`=IF(E2<>"", IMAGE(E2, 4, 80, 80), "")`
  - [ ] 將公式向下拖曳到所有列（至少 F100）

- [ ] **調整欄寬（選用）**
  - [ ] E 欄寬度：約 300px
  - [ ] F 欄寬度：約 100px

---

## 🧪 測試清單

### 功能測試

#### 1. 照片上傳測試（手機）

- [ ] 使用手機開啟網頁
- [ ] 登入 Google 帳號
- [ ] 輸入借用人學號和設備條碼
- [ ] 點擊「拍照或選擇照片」按鈕
- [ ] **測試拍照**
  - [ ] 拍照功能正常啟動
  - [ ] 照片預覽顯示正確
  - [ ] 點擊「借出」按鈕
  - [ ] 顯示「正在上傳照片...」訊息
  - [ ] 顯示「借出成功」訊息
- [ ] **測試選擇照片**
  - [ ] 從相簿選擇照片
  - [ ] 照片預覽顯示正確
  - [ ] 上傳成功

#### 2. 照片上傳測試（電腦）

- [ ] 使用電腦開啟網頁
- [ ] 點擊「拍照或選擇照片」按鈕
- [ ] 選擇圖片檔案
- [ ] 照片預覽顯示正確
- [ ] 上傳成功

#### 3. Sheets 照片顯示測試

- [ ] 開啟 Google Sheets
- [ ] 前往 records 工作表
- [ ] **檢查 E 欄（photoUrl）**
  - [ ] 有借用記錄的 URL 格式為：`https://drive.google.com/uc?id=...`
  - [ ] URL 可點擊並正常開啟照片
- [ ] **檢查 F 欄（照片預覽）**
  - [ ] 有 URL 的記錄顯示 80x80 照片縮圖
  - [ ] 沒有 URL 的記錄顯示空白
  - [ ] 沒有顯示 #VALUE! 或其他錯誤

#### 4. 前端照片顯示測試

- [ ] **設備狀態標籤**
  - [ ] 切換到「設備狀態」標籤
  - [ ] 未歸還設備列表有「照片」欄
  - [ ] 有照片的記錄顯示「查看照片」按鈕
  - [ ] 點擊按鈕能在新分頁開啟完整照片
  - [ ] 沒有照片的記錄顯示 `-`

- [ ] **借用記錄標籤**
  - [ ] 切換到「借用記錄」標籤
  - [ ] 記錄表格有「照片」欄
  - [ ] 有照片的記錄顯示「查看照片」按鈕
  - [ ] 點擊按鈕能在新分頁開啟完整照片
  - [ ] 沒有照片的記錄顯示 `-`

#### 5. 照片壓縮測試

- [ ] 上傳大於 1MB 的照片
- [ ] 照片成功壓縮（檔案大小變小）
- [ ] 照片品質仍可接受
- [ ] 上傳成功

#### 6. 無照片借用測試

- [ ] 不拍照，直接借出設備
- [ ] 借出成功
- [ ] Sheets 中 E 欄為空
- [ ] F 欄為空
- [ ] 前端顯示 `-`

#### 7. 移除照片測試

- [ ] 選擇照片後點擊「移除照片」按鈕
- [ ] 照片預覽消失
- [ ] 借出時不上傳照片
- [ ] 記錄無照片 URL

---

## 🔍 錯誤排查

### 常見問題

#### ❌ 照片上傳失敗

**可能原因**:
- Apps Script 未啟用 Drive API
- Drive API quota 超過限制
- 網路連線問題

**解決方法**:
1. 檢查 Apps Script 執行日誌
2. 確認 Drive API 已啟用
3. 等待一段時間後重試

#### ❌ Sheets 顯示 #VALUE! 錯誤

**可能原因**:
- IMAGE 公式語法錯誤
- URL 格式不正確

**解決方法**:
1. 檢查 F2 公式是否正確
2. 確認 E 欄 URL 格式為 `https://drive.google.com/uc?id=...`

#### ❌ 照片無法開啟

**可能原因**:
- Drive 檔案權限設定錯誤
- 檔案已被刪除

**解決方法**:
1. 檢查 Drive 中的 LibGear_Photos 資料夾
2. 確認檔案權限為「知道連結的任何人都能檢視」

#### ❌ 手機拍照按鈕無反應

**可能原因**:
- 瀏覽器不支援 `capture="environment"` 屬性
- 未授予相機權限

**解決方法**:
1. 檢查瀏覽器設定，允許網站使用相機
2. 更新瀏覽器到最新版本
3. 改用「選擇照片」功能

---

## 📊 版本驗證

### 前端版本確認

1. 開啟網頁
2. 按 F12 開啟開發者工具
3. 切換到 Console
4. 輸入：`SYSTEM_CONFIG.VERSION`
5. 應顯示：`"v1.2.0"`

### 後端版本確認

1. 開啟網頁
2. 查看頁面底部版本資訊
3. 應顯示：
   - Frontend: v1.2.0
   - Backend: v1.3.0

---

## 📝 完成確認

- [ ] 所有部署步驟已完成
- [ ] 所有測試項目通過
- [ ] 無錯誤訊息
- [ ] Sheets 照片正常顯示
- [ ] 前端照片正常顯示
- [ ] 手機和電腦都能正常使用

---

## 🎉 部署完成！

照片功能已成功部署並可以使用。

**後續維護提醒**:
- 定期檢查 Drive 儲存空間（免費版 15GB）
- 若空間不足，可手動刪除舊照片或升級 Google One
- 建議定期備份 LibGear_Photos 資料夾
